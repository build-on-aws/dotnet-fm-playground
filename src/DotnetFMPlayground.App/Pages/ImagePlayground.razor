@page "/image-playground"
@using Amazon.Bedrock.Model;
@using System.Text;
@using Amazon.Bedrock;
@using Amazon.BedrockRuntime;
@using DotnetFMPlayground.Core.Models;
@using DotnetFMPlayground.Core.Models.InferenceParameters.AmazonTitanImageGeneratorG1
@using DotnetFMPlayground.Core.Models.ModelResponse
@inject AmazonBedrockRuntimeClient BedrockRuntimeClient
@inject AmazonBedrockClient BedrockClient
@inject IJSRuntime JS

<MudText Typo="Typo.h3">Image Playground</MudText>
<MudStack>
<MudCard>
    <MudCardContent>
        <MudSelect T="FoundationModelSummary" @bind-Value="selectedModel" ToStringFunc="@selectConverter" Required="true">
            @if (foundationModels != null)
            {
                foreach (var item in foundationModels)
                {
                    selectedModel ??= item;
                    <MudSelectItem Value="@item"/>
                }
            }
        </MudSelect>
    </MudCardContent>
</MudCard>
<EditForm Model="@userPrompt" OnSubmit="OnSubmit">
    <MudCard>
        <MudCardContent>
            <MudTextField Counter=0 id="PromptId" Label="Prompt" @bind-Value="userPrompt.Prompt" Lines=5 Variant="Variant.Outlined" />
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Submit</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>
@if (imageSrc != String.Empty)
{
    <MudPaper id="ImageId" Class="d-flex justify-center">
        <MudImage Class="pa-4" Src="@imageSrc"></MudImage>
    </MudPaper>
}
</MudStack>

@code {
    public class UserPrompt
    {
        public string Prompt { get; set; }
    }

    private IEnumerable<FoundationModelSummary> foundationModels;

    private FoundationModelSummary selectedModel;

    private UserPrompt userPrompt = new UserPrompt();

    Func<FoundationModelSummary, string> selectConverter = fms => fms == null ? "" : String.Concat(fms?.ModelName, " (", fms?.ModelId, ")");

    private string imageSrc = "";

    protected override async Task OnInitializedAsync()
    {
        foundationModels = (await BedrockClient.ListFoundationModelsAsync(new ListFoundationModelsRequest())).ModelSummaries.Where(x => x.OutputModalities.Contains("IMAGE") && ModelIds.IsSupported(x.ModelId));
        selectedModel = foundationModels.FirstOrDefault();
        await base.OnInitializedAsync();
        StateHasChanged();
    }

    private async Task OnSubmit(EditContext context)
    {

        Prompt prompt =
        [
            new PromptItem(PromptItemType.User, userPrompt.Prompt)
        ];

        if (selectedModel.ModelId == "amazon.titan-image-generator-v1")
        {   
            AmazonTitanImageGeneratorG1Response response = await BedrockRuntimeClient.InvokeTitanImageGeneratorG1ForTextToImageAsync(
                new TextToImageParams()
                {
                    Text = new StringBuilder().AppendJoin(' ', prompt.Select(x => x.Prompt)).ToString()
                },
                new ImageGenerationConfig()
                {
                    NumberOfImages = 1,
                    CfgScale = 8.0f,
                    Height = 512,
                    Width = 512,
                    Quality = ImageGenerationConfig.ImageQuality.Standard,
                    Seed = 10
                });
            imageSrc = $"data:image/jpeg;base64,{(object)response?.Images?.FirstOrDefault()}";
        }
        else if (selectedModel.ModelId == ModelIds.STABILITY_AI_STABLE_DIFFUSION_XL_V0)
        {
            StableDiffusionXLResponse response = await BedrockRuntimeClient.InvokeStabilityAIStableDiffusionXLv1ForTextToImageAsync(
                new Core.Models.InferenceParameters.StabilityAIStableDiffusionXL.TextToImageParams
                {
                    TextPrompts = new []{ new Core.Models.InferenceParameters.StabilityAIStableDiffusionXL.TextToImageParams.TextPrompt() { Text = new StringBuilder().AppendJoin(' ', prompt.Select(x => x.Prompt)).ToString()}},
                });
            imageSrc = $"data:image/jpeg;base64,{(object)response?.Artifacts?.FirstOrDefault()?.Base64}";
        }
        StateHasChanged();
        await JS.InvokeVoidAsync("scrollToElement", "ImageId");
    }
}
